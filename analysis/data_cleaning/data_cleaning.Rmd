---
title: "Data Cleaning"
author: "Quinn White"
date: '`r Sys.Date()`'
output:
  rmdformats::readthedown:
    df_print: paged
    code_folding: show
    css: ../../css/template.css
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval=FALSE, message=FALSE,warning=FALSE)

```



```{css, echo = FALSE}
#content{
max-width:1920px;
}
  
``` 


```{r,eval=TRUE}

library(tidyverse)
library(lubridate)


```

# File Descriptions


### Demographic 
* `population_2019.RDS` contains the population for each fips code
* `statecodes.csv` contains state names mapped to codes
* `county_fips.tsv` contains fips code mapped to county name and state 

### Covidestim
* `covidestim_original_all.RDS` is an RDS file of the covidestim csv from the link `https://covidestim.s3.us-east-2.amazonaws.com/latest/state/estimates.csv`, unmodified; includes dates through 2021 earlier than 2021-12-02
* `covidestim_last_weeks_all_states.RDS` contains estimates after 2021-12-02 from `https://api2.covidestim.org/latest_runs?geo_type=eq.state&select=*,timeseries(*)`
* `covidestim_biweekly_all_states.RDS` is the cases summed for each 2-week interval, including data from `https://covidestim.s3.us-east-2.amazonaws.com/latest/state/estimates.csv` to obtain dates before 2021-12-02 (latest date available is 2021-11-30) and data from `https://api2.covidestim.org/latest_runs?geo_type=eq.state&select=*,timeseries(*)` to obtain dates after  2021-12-02
* `covidestim_county_estimates.RDS` contains estimates of infections by date and fips from `https://covidestim.s3.us-east-2.amazonaws.com/latest/estimates.csv`, no modifications other than selecting variables of interest
* `covidestim_biweekly_all_counties.RDS` contains biweekly aggregates for all counties, data again from link `https://covidestim.s3.us-east-2.amazonaws.com/latest/estimates.csv`





```{r demographic info, eval=TRUE}

# STRUCTURE: fips, state, week, negative, positive, total, posrate

data_path <- paste0(here::here(), "/data/")


########################################  
#CENSUS DATA POPULATION ESTIMATES 
########################################  
url_2019 <- "https://www2.census.gov/programs-surveys/popest/datasets/2010-2019/counties/totals/co-est2019-alldata.csv"

population_2019 <- read_csv(url_2019) %>%
  mutate(fips_code = paste0(STATE, COUNTY)) %>%
  select(fips_code, population =POPESTIMATE2019)

population_2019 %>%
  head()

saveRDS(population_2019,
        paste0(here::here(), 
        "/data/demographic/population_2019.RDS"))

```


# Covidestim

## Covidestim All States (State-level)

Due to changes in the model to handle the Omicron wave, we have to obtain dates before 2021-12-02 from a different source than the latest runs endpoint of the API.

```{r, eval = TRUE}

# set end date
end_date <- ymd("2022-02-25")

```

```{r covidestim all states last weeks, eval = TRUE}

########################################
# COVIDESTIM BIWEEKLY DATA ALL STATES
########################################

covidestim_api_link <- "https://api2.covidestim.org/latest_runs?geo_type=eq.state&select=*,timeseries(*)"
covidestim <- httr::GET(covidestim_api_link)


# only go to the 6th because these are already weekly counts
# get the last couple weeks of 2021
last_weeks <-jsonlite::fromJSON(
  httr::content(covidestim,
                as = "text",
                encoding = "UTF-8"),
  simplifyVector = TRUE,
  flatten = TRUE)  %>%
  unnest(timeseries, names_repair = "unique") %>%
  mutate( date = ymd(date),
          week = week( date)) %>%
  filter(date <= end_date & year(date) > 2020)

last_weeks <- last_weeks %>%
  select(date, 
         infections.lo = infections_p2_5,
         infections.hi =infections_p97_5,
         infections, created_at,
         state = geo_name) %>%
  mutate(week = week(date),
         created = substr(created_at, 1, 10),
         created = ymd(created))

# remove duplicates from multiple model runs by taking most recent
last_weeks <- last_weeks %>%
  group_by(week,date) %>%
  slice_max(order_by = created, n=1) %>%
  select(-c(created,created_at)) %>%
  mutate(year = year(date)) %>%
  mutate(week = case_when(
    year == 2022 ~ week + 52,
    year == 2021 ~ week
  ))

last_weeks %>%
  head()

saveRDS(last_weeks,
         file = paste0(
           here::here(), 
           "/data/covidestim/covidestim_last_weeks_all_states.RDS"))

```

```{r,eval=TRUE}

# access dates before 2021-12-02
covidestim_link <- "https://covidestim.s3.us-east-2.amazonaws.com/latest/state/estimates.csv"

covidestim_allstates <- read_csv(covidestim_link)

covidestim_allstates %>%
  head()

saveRDS(covidestim_allstates,
        file = paste0(here::here(), 
               "/data/covidestim/covidestim_original_all.RDS"))

```

```{r, eval = TRUE}

covidestim <- readRDS(
  paste0(
    here::here(),
    "/data/covidestim/covidestim_original_all.RDS"))

# join data from each source to include dates before and after 2021-12-02
covidestim <- covidestim %>%
  select(date, contains("infections"), state) %>%
  filter(date <= end_date & year(date) > 2020) %>%
  mutate(week = week(date), year = year(date)) %>%
  mutate(week = case_when(
    year == 2022 ~ week + 52,
    year == 2021 ~ week
  )) %>%
  bind_rows(last_weeks) %>%
  group_by(week, state, year) %>%
  summarize(across(contains("infections"), sum), date = min(date)) %>%
  ungroup()

# look at discontinuity for example
covidestim %>%
  filter(state == "Colorado") %>%
  mutate(source = ifelse(date <= ymd("2021-12-02"), "1", "2")) %>%
  ggplot(aes(x = week, 
             y = infections,
             color = source,
             ymin = infections.lo,
             ymax = infections.hi)) +
  geom_ribbon(alpha = .5, aes(fill = source)) +
  geom_line() +
  geom_point(alpha = .7) +
  theme_bw() +
  labs(title = "Change in Data Source, Colorado")


###############
# add biweek
###############

num_weeks <- covidestim %>% 
  pull(week) %>% 
  unique() %>% 
  length()

num_biweeks <- num_weeks/2

biweek <- tibble(biweek = c(rep(1:num_biweeks, 2))) %>%
  arrange(biweek)

biweek_to_week <- covidestim %>%
  select(week) %>%
  distinct() %>%
  arrange(week) %>%
  cbind(biweek =biweek)

# calculate biweekly sums
covidestim_biweekly <- covidestim %>%
  left_join(biweek_to_week) %>%
  group_by(biweek, state)  %>%
  mutate(across(
    contains("infections"), 
    sum)) %>%
  ungroup()


# add state codes
statecodes <- read_csv(paste0(
  here::here(),
  "/data/demographic/statecodes.csv")) %>%
  rename(state_name = state,
         state = code) %>%
  select(-abbrev)

covidestim_biweekly %>%
  rename(state_name = state) %>%
  left_join(statecodes) %>%
  saveRDS(paste0(
    here::here(),
    "/data/covidestim/covidestim_biweekly_all_states.RDS")) 


```


## Covidestim All States (County Level)

```{r county level estimates, eval=TRUE}

# if legacy file does not exist, acquire it from link
if(!file.exists(
  paste0(
      here::here(), 
      "/data/covidestim/covidestim_county_estimates.RDS"))) {
  
  legacy_link <- "https://covidestim.s3.us-east-2.amazonaws.com/latest/estimates.csv"
  
  estimates_legacy <- read_csv(legacy_link) %>%
    select(fips, date, infections)
  
  saveRDS(
    estimates_legacy,
    paste0(
      here::here(), 
      "/data/covidestim/covidestim_county_estimates.RDS"))
}




```


```{r,eval=TRUE}

county_estimates_path <- paste0(
  here::here(), 
  "/data/covidestim/covidestim_county_estimates.RDS")

covidestim_county <- readRDS(county_estimates_path) %>%
  filter(date <= end_date &  year(date) > 2020) %>%
  mutate(week = week(date),
         year = year(date)) %>%
  mutate(week = case_when(
    year == 2022 ~ week + 52,
    year == 2021 ~ week
  ))
  

num_weeks <- covidestim_county %>% 
  pull(week) %>% 
  unique() %>% 
  length()

num_biweeks <- num_weeks/2

biweek <- tibble(biweek = c(rep(1:num_biweeks, 2))) %>%
  arrange(biweek)

biweek_to_week <- covidestim_county %>%
  select(week) %>%
  distinct() %>%
  arrange(week) %>%
  cbind(biweek =biweek)

```

```{r, include = FALSE, eval = FALSE}
########################################
# HANDLE GROUPED COUNTIES IN MA
########################################
# these counties are grouped in the data reported by MA, 
# so grouping them here
county_fips <- read_tsv("./data/county_fips.tsv") %>%
  dplyr::rename_with(.cols =everything(), tolower)

data_ma <- readRDS("./data/ma/all.RDS")

together <- county_fips %>% 
  filter(name == "Dukes" | name == "Nantucket") %>%
  pull(fips) %>%
  paste0(collapse = ",")

#### fix population to add populations together
grouped <- county_fips %>% 
  filter(name == "Dukes" | name == "Nantucket") %>%
  pull(fips)

# NOTE = it turns out covidestim doesn't actually include these counties, so nothing to fix
covidestim_county <- covidestim_county %>%
  mutate(fips = ifelse(fips %in% grouped, paste0(fips, sep = ","), fips))


```

```{r,eval=TRUE}
############################################
# SUM FOR EACH BIWEEK IN EACH COUNTY
############################################


covidestim_biweekly_all_counties <- covidestim_county %>%
  left_join(biweek_to_week) %>%
  group_by(biweek, fips)  %>%
  mutate(across(contains("infections"), sum)) %>%
  ungroup() 
  
covidestim_biweekly_all_counties %>%
  head()

covidestim_biweekly_all_counties %>% 
  saveRDS(file = paste0(
    here::here(), 
    "/data/covidestim/covidestim_biweekly_all_counties.RDS"))

```





# County-level Cases

## Michigan 




```{r, eval=TRUE}

county_fips <- read_tsv(paste0(
  here::here(),
  "/data/demographic/county_fips.tsv")) %>%
  dplyr::rename_with(.cols =everything(), tolower)

```




```{r michigan county, eval = TRUE}


###############################
# MICHIGAN BIWEEKLY DATA
###############################


if(!file.exists(paste0(here::here(),
                     "/data/county_level/mi/mi_county_original.RDS"))) {
  link <- paste0("https://www.michigan.gov/coronavirus/-/media/Project/Websites/coronavirus/",
                 "Michigan-Data/09-27-2022/Datasets/Diagnostic-Tests-by-Result-and-County-2022-09-27.xlsx?",
                 "rev=7ba61151dcff4b038e33ea9ead95137c&hash=6C1AA97E93A30A3C1F10171233FDF31A")
  httr::GET(link, httr::write_disk(tf <- tempfile(fileext = ".xlsx")))
  df <- readxl::read_excel(tf)
  saveRDS(df, file = paste0(
    here::here(),
    "/data/county_level/mi/mi_county_original.RDS"))
}
  
  
counts_raw <- readRDS(paste0(
  here::here(),
  "/data/county_level/mi/mi_county_original.RDS"))

# basic reformatting; join fips code and population
counts_raw <- counts_raw %>%
  mutate(week = week(MessageDate),
         date = ymd(MessageDate)) %>%
  dplyr::rename_with(.cols =everything(), tolower) %>%
  mutate(state = "MI") %>%
  left_join(county_fips,
            by = c("county"="name",
                   "state" = "state")) %>%
  select(-messagedate) %>%
  left_join(population_2019, by = c("fips" = "fips_code"))

counts_raw %>%
  saveRDS(., file =  paste0(
    here::here(),
  "/data/county_level/mi/mi_county_daily.RDS"))


# county <- counts_raw %>%
#   dplyr::rename_with(.cols =everything(), tolower) %>%
#   mutate(
#     date = ymd(messagedate),
#     week = week(date),
#     year = year(date)) %>%
#   filter(year > 2020 & date <= end_date) %>%
#   mutate( week = case_when(
#     year == 2021 ~ week,
#     year == 2022 ~ week + 52)) %>%
#   select(fips, county, positive, date, total, week, negative) %>%
#   mutate(state = "MI") %>%
#   left_join(county_fips, by = c("state" ="state",
#                                 "county" = "name")) %>%
#   filter(!is.na(fips)) %>%
#   select(-county)


county <- counts_raw %>% 
  mutate(
    week = week(date),
    year = year(date)) %>%
  filter(year > 2020 & date <= end_date) %>%
  mutate( week = case_when(
    year == 2021 ~ week,
    year == 2022 ~ week + 52)) %>%
  select(fips, county, positive, 
         date, total, week, 
         negative, population) %>%
  mutate(state = "MI")
  


######################
# ADD BIWEEK
######################
num_weeks <- unique(county$week) %>%
  length()

num_biweeks <- num_weeks/2

biweek <- tibble(biweek = c(rep(1:num_biweeks, 2))) %>%
  arrange(biweek)

biweek_to_week <- county %>%
  select(week) %>%
  distinct() %>%
  arrange(week) %>%
  cbind(biweek =biweek)

county_biweekly <- county %>%
  left_join(biweek_to_week) %>%
  group_by(biweek, fips)  %>%
  mutate(across(c(total,positive, negative),
                 sum)) %>%
  ungroup() %>%
  mutate(posrate = positive/ total) %>%
  select(-week)


county_biweekly %>%
  saveRDS(paste0(here::here(), 
               "/data/county_level/mi/mi_county_biweekly.RDS"))


readRDS(paste0(
  here::here(), 
  "/data/county_level/mi/mi_county_biweekly.RDS")) %>%
  mutate(week = week(date), year=year(date)) %>%
  mutate(
         week = case_when(
           year == 2021 ~week,
           year == 2022 ~ week + 52
         )) %>%
  select(biweek,date) %>%
    distinct() %>%
  saveRDS(paste0(here::here(),
                 "/data/date_to_biweek.RDS"))


```


# All States Hospitalizations


```{r}

############### MICHIGAN HOSPITALIZATIONS ######################

##### WEEKLY
# https://dev.socrata.com/foundry/healthdata.gov/g62h-syeh
hosp <- httr::GET(URLencode("https://healthdata.gov/resource/g62h-syeh.json?$where=date between '2020-12-31T12:00:00' and '2022-02-25T14:00:00'&$select=deaths_covid,date,percent_of_inpatients_with_covid,inpatient_beds_used_covid,inpatient_beds_used,state&$limit=50000"))

hosp <-jsonlite::fromJSON(
  httr::content(hosp,
                as="text",
                encoding = "UTF-8")) %>%
  as_tibble()


hosp <- hosp %>%
  mutate(date = gsub("T.*", "",date),
         date = as.Date(date, format = "%Y-%m-%d"),
         week = week(date)) %>%
  mutate(across(-c(date,state), as.numeric))

hosp_weekly <- hosp %>%
  mutate(
    year = year(date)) %>%
  mutate(across(-c(date,state), as.numeric)) %>%
  mutate(week = case_when(
    year == 2021 ~ week,
    year == 2022 ~ week + 52
  ))


num_weeks <- unique(hosp_weekly$week) %>%
  length()

num_biweeks <- num_weeks/2

biweek <- tibble(biweek = c(rep(1:num_biweeks, 2))) %>%
  arrange(biweek)

biweek_to_week <- hosp_weekly %>%
  select(week) %>%
  distinct() %>%
  arrange(week) %>%
  cbind(biweek =biweek)

###### WEEKLY
hosp_weekly %>%
  group_by(week,state) %>%
  mutate(across(c(deaths_covid, 
                  inpatient_beds_used_covid,
                  inpatient_beds_used),
                sum))  %>%
  saveRDS(paste0(here::here(), "/data/all_states/hosp_weekly_allstates.RDS"))
  
###### BIWEEKLY
hosp_weekly %>%
  left_join(biweek_to_week) %>%
  group_by(biweek, state) %>%
  mutate(across(c(deaths_covid, 
                  inpatient_beds_used_covid,
                  inpatient_beds_used),
                sum)) %>%
  saveRDS(paste0(here::here(), "/data/all_states/hosp_biweekly_allstates.RDS"))
  

```




# Michigan Hospitalizations

```{r}

############### MICHIGAN HOSPITALIZATIONS ######################

##### WEEKLY
# https://dev.socrata.com/foundry/healthdata.gov/g62h-syeh
hosp <- httr::GET(URLencode("https://healthdata.gov/resource/g62h-syeh.json?state=MI&$where=date between '2020-12-31T12:00:00' and '2022-02-25T14:00:00'&$select=deaths_covid,date,percent_of_inpatients_with_covid,inpatient_beds_used_covid,inpatient_beds_used,state"))

mi_hosp <-jsonlite::fromJSON(
  httr::content(hosp,
                as="text",
                encoding = "UTF-8")) %>%
  as_tibble()


mi_hosp <- mi_hosp %>%
  mutate(date = gsub("T.*", "",date),
         date = as.Date(date, format = "%Y-%m-%d"),
         week = week(date)) %>%
  mutate(across(-c(date,state), as.numeric))

mi_hosp_weekly <- mi_hosp %>%
  mutate(
    year = year(date)) %>%
  mutate(across(-c(date,state), as.numeric)) %>%
  mutate(week = case_when(
    year == 2021 ~ week,
    year == 2022 ~ week + 52
  ))


num_weeks <- unique(mi_hosp_weekly$week) %>%
  length()

num_biweeks <- num_weeks/2

biweek <- tibble(biweek = c(rep(1:num_biweeks, 2))) %>%
  arrange(biweek)

biweek_to_week <- mi_hosp_weekly %>%
  select(week) %>%
  distinct() %>%
  arrange(week) %>%
  cbind(biweek =biweek)

###### WEEKLY
mi_hosp_weekly %>%
  group_by(week) %>%
  mutate(across(c(deaths_covid, 
                  inpatient_beds_used_covid,
                  inpatient_beds_used),
                sum))  %>%
  saveRDS(paste0(here::here(), "/data/michigan/mi_hosp_weekly.RDS"))
  
###### BIWEEKLY
mi_hosp_weekly %>%
  left_join(biweek_to_week) %>%
  group_by(biweek) %>%
  mutate(across(c(deaths_covid, 
                  inpatient_beds_used_covid,
                  inpatient_beds_used),
                sum)) %>%
  saveRDS(paste0(here::here(), "/data/michigan/mi_hosp_biweekly.RDS"))
  

```

```{r, eval = FALSE}

##################################
# OLD VERSION 
##################################


#### BIWEEKLY
# up until 13th
hosp <- httr::GET(
  URLencode(paste0(
    "https://healthdata.gov/resource/g62h-syeh.json?state=MI&$where=date between '2021-01-01T12:00:00'",
    "and '2022-01-13T14:00:00'&$select=deaths_covid,date,percent_of_inpatients_with_covid,inpatient_beds_used_covid,inpatient_beds_used,state")))

mi_hosp <-jsonlite::fromJSON(
  httr::content(hosp,
                as="text",
                encoding = "UTF-8")) %>%
  as_tibble()

mi_hosp_weekly <- mi_hosp %>%
  mutate(
    year = year(date)) %>%
  mutate(across(-c(date,state), as.numeric)) %>%
  mutate(date = ymd(substr(date, 1,10)),
         year = year(date),
         week = week(date))


##### ADD BIWEEK #######

num_weeks <- unique(county$week) %>%
  length()

num_biweeks <- num_weeks/2

biweek <- tibble(biweek = c(rep(1:num_biweeks, 2))) %>%
  arrange(biweek)

biweek_to_week <- county %>%
  select(week) %>%
  distinct() %>%
  arrange(week) %>%
  cbind(biweek =biweek)

county_biweekly <- county %>%
  left_join(biweek_to_week) %>%
  group_by(biweek, fips)  %>%
  mutate(across(c(total,positive, negative),
                sum)) %>%
  ungroup() %>%
  mutate(posrate = positive/ total) %>%
  select(-week)


biweek <- map(1:26, ~rep(.x,2)) %>% unlist()
biweek <- c(biweek, 27,27, 27)


week_to_biweek <- mi_hosp_weekly %>%
  mutate(year = year(date),
         week = week(date)) %>%
  select(week, year ) %>%
  distinct() %>%
  arrange(year,week) %>%
  cbind(biweek = biweek)


hosp_biweekly <- mi_hosp_weekly %>%
  arrange(date) %>%
  left_join(week_to_biweek,
            by = c("year" = "year",
                   "week" = "week")) %>%
  group_by(biweek) %>%
  summarize(across(c(inpatient_beds_used,
                     inpatient_beds_used_covid,
                     deaths_covid), sum),
            date = min(date))

saveRDS(hosp_biweekly, "./data/hosp_mi_biweekly.RDS")

```



# Massachusetts

```{r}


county_fips <- read_tsv("./data/county_fips.tsv") %>%
  dplyr::rename_with(.cols =everything(), tolower)


url_2019 <- "https://www2.census.gov/programs-surveys/popest/datasets/2010-2019/counties/totals/co-est2019-alldata.csv"


population_2019 <- read_csv(url_2019) %>%
  mutate(fips_code = paste0(STATE, COUNTY)) %>%
  select(fips_code, population =POPESTIMATE2019, county_name = CTYNAME)


```

```{r,eval=FALSE}

########## TESTING ###########
# link <- "https://www.mass.gov/doc/covid-19-raw-data-june-30-2022/download"
# 
# tf <- httr::GET(link, httr::write_disk(tf <- tempfile(fileext = ".xlsx")))
# df <- readxl::read_excel(tf, sheet = "County_Weekly")
# 
# df <- df %>% 
#   select(contains("date"), 
#          total = `Total Tests (Last 14 days)`,
#          positive = `Total Positive Tests (Last 14 days)`,
#          county_name =County) %>%
#   mutate(state = "MA")
# 
# 
# df <- df %>%
#   mutate(county_name = gsub(" County", "", county_name),
#          county_name = trimws(county_name)) %>%
# 
#   
#   
# df_fips <- df %>%
#   left_join(county_fips,
#             by = c("county_name" = "name", 
#                    "state" = "state")) %>%
#   filter(!is.na(fips)) 

```

```{r,eval=FALSE}

# SCRAPE LINKS FROM HTML
all_links <- tibble(lines = c(readLines("./data/ma/ma_2022.html"),
                 readLines("./data/ma/ma_2021.html"))) %>%
  filter(grepl("/doc/covid-19-raw-data-", lines)) %>%
  mutate(lines = str_extract(lines, '".*."'))%>%
  mutate(lines = gsub('"', "", lines)) %>%
  mutate(lines = gsub(">.*", "", lines)) %>%
  mutate(link = paste0("https://www.mass.gov", lines)) %>% 
  pull(link)
  
  
read_data <- function(link) {
  httr::GET(link, httr::write_disk(tf <- tempfile(fileext = ".xlsx")))
  df <- readxl::read_excel(tf, sheet = "County_Weekly")
  
  df %>% 
    select(contains("date"), 
           total = `Total Tests (Last 14 days)`,
           positive = `Total Positive Tests (Last 14 days)`,
           county_name =County) %>%
    mutate(state = "MA")

}

d <- read_data(all_links[1])

data_ma <- map_df(all_links, ~ {
  
  tryCatch(
        {
          read_data(link)
        },
        error=function(cond) {
            message(paste("Issue with:", link))
            message("Original error message:")
            message(cond)
            # Choose a return value in case of error
            return(NULL)
        })
}
)

saveRDS(data_ma, "./data/ma/all.RDS")
```

```{r}

data_ma <- readRDS("./data/ma/all.RDS")


# only NAs are from counties that were combined
data_ma %>%
  filter(is.na(total) | is.na(positive)) %>%
  pull(county_name) %>%
  unique()


together <- county_fips %>% 
  filter(name == "Dukes" | name == "Nantucket") %>%
  pull(fips) %>%
  paste0(collapse = ",")

#### fix population to add populations together
grouped <- county_fips %>% 
  filter(name == "Dukes" | name == "Nantucket") %>%
  pull(fips)

county_fips <- county_fips %>%
  filter(!(name == "Dukes" | name == "Nantucket")) %>%
  bind_rows(tibble(name = "Dukes and Nantucket", 
                   fips = together, 
                   state = "MA"))

 

population_2019 <- population_2019 %>%
  mutate(fips_code = ifelse(fips_code %in% grouped,
                            together, 
                            fips_code)) %>%
  group_by(fips_code) %>%
  summarize(population = sum(population))


```

```{r,eval =FALSE}


data_ma <- data_ma %>%
  filter(!(is.na(total) | is.na(positive))) %>%
  filter(!county_name %in% c("All of Massachusetts", "Unknown County")) %>%
  rename_with( ~tolower(gsub(" ", "_", .)), contains("date") ) %>%
  mutate(across(contains("date"), ymd))

data_ma %>%
  mutate(county_name = gsub(" County", "", county_name),
         county_name = gsub(" Counties", "", county_name),
         county_name = trimws(county_name)) %>%
  left_join(county_fips, by = c("state"="state", "county_name"="name")) %>%
  saveRDS("./data/ma/ma_full_county.RDS")


```

```{r, eval = FALSE}

# JHU data to compare if needed
cases_all <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv")

cases <- cases_all %>%
  filter(Province_State == "Massachusetts") %>%
  pivot_longer(12:ncol(.), names_to = "date", values_to = "confirmed") %>%
  mutate(date = mdy(date)) %>%
  filter(date >= ymd("2021-01-01") & date <=ymd("2021-02-25"))


```


```{r}

data_ma <- readRDS("./data/ma/ma_full_county.RDS") %>% distinct()

data_ma <- data_ma %>%
  mutate(year = year(start_date),
         week = week(start_date)) %>%
  filter(year> 2020 & start_date <= end_date) %>%
  mutate( week = case_when(
    year == 2021 ~ week,
    year == 2022 ~ week + 52)) 

# note that dates are overlapping, so remove the duplicates
startdate_to_biweek <- data_ma %>%
  filter(!week %% 2 ==0) %>%
  select(-week) %>%
  select(start_date) %>%
  distinct() %>%
  arrange(start_date) %>%
  mutate(biweek = row_number())


data_ma %>%`
  filter(!week %% 2 ==0) %>%
  left_join(startdate_to_biweek) %>%
  select(-c(week, end_date,report_date)) %>%
  left_join(population_2019, by = c("fips" = "fips_code")) %>%
  rename(date = start_date) %>%
  mutate(posrate = positive/total) %>%
  saveRDS("./data/ma/ma_county_biweekly.RDS")
  
  
```


# County Level Hospitalizations

```{r}
dates <- readRDS("./data/date_to_biweek.RDS")

httr::GET("https://data.cdc.gov/resource/3nnm-4jni.json?state=Massachusetts")

httr::GET(URLencode("https://healthdata.gov/resource/g62h-syeh.json?state=MA&$where=date between '2020-12-31T12:00:00' and '2022-02-25T14:00:00'&$select=deaths_covid,date,percent_of_inpatients_with_covid,inpatient_beds_used_covid,inpatient_beds_used,state"))


# input full name
get_county_hosp <- function(state) {
  link <- paste0("https://data.cdc.gov/resource/3nnm-4jni.json?state=", 
                 state, "&$where=date_updated between '2021-01-01T12:00:00' and ",
                 "'2022-02-25T14:00:00'&$select=date_updated,",
                 "covid_hospital_admissions_per_100k,",
                 "state,county_population,county_fips")
  hosp <- httr::GET(URLencode(link))
  
  
  hosp <-jsonlite::fromJSON(
    httr::content(hosp,
                  as="text",
                  encoding = "UTF-8")) %>%
  as_tibble()
  
  hosp <- hosp %>%
    rename(date = date_updated) %>% 
    mutate(date = gsub("T.*", "",date),
           date = as.Date(date, format = "%Y-%m-%d")) %>%
    mutate(across(-c(date,state), as.numeric))

  
  hosp %>%
    mutate(pop_100k = county_population/100000, 
           hosp = covid_hospital_admissions_per_100k * pop_100k) %>%
    inner_join(dates) %>%
    group_by(biweek, state, county_fips) %>%
    summarize(hosp = sum(hosp)) %>%
    ungroup()

}
  

data <- get_county_hosp("Massachusetts")
saveRDS(data, "./data/hosp/county_hosp_ma.RDS")


data <- get_county_hosp("Michigan")
saveRDS(data, "./data/hosp/county_hosp_mi.RDS")



```


